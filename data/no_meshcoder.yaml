# ============================================================================
# Alternative Config: No MeshCoder Access
# ============================================================================
# Use this config when MeshCoder dataset is behind a gated form or
# otherwise unavailable. Compensates with heavier Infinigen extraction,
# broader Objaverse LLM generation, and synthetic self-play data.
# ============================================================================

global:
  output_dir: "./output/sft_dataset_alt"
  seed: 42
  total_samples: 5000
  num_workers: 8
  blender_path: "blender"
  blender_timeout: 120

views:
  min_views: 1
  max_views: 6
  count_weights:
    1: 0.20
    2: 0.20
    3: 0.20
    4: 0.20
    5: 0.10
    6: 0.10
  selection_strategy: "azimuth_spread"
  elevation_jitter_deg: 10
  render_resolution: [512, 512]

quality_gate:
  min_reward: 0.10
  min_f_score_005: 0.08
  max_chamfer: 0.05
  min_code_length: 200
  max_code_length: 15000
  require_geometry_ops: true
  geometry_op_keywords:
    - "primitive_cube_add"
    - "primitive_cylinder_add"
    - "primitive_uv_sphere_add"
    - "primitive_cone_add"
    - "primitive_torus_add"
    - "from_pydata"
    - "boolean"
    - "bevel"
    - "solidify"
    - "array"
    - "extrude"
    - "curve"
    - "bezier"
    - "spin"
    - "screw"

# --- Dataset Sources (No MeshCoder) ----------------------------------------
datasets:
  meshcoder:
    enabled: false               # DISABLED — not available

  # --- Infinigen: extract procedural scripts from source ---
  infinigen:
    enabled: true
    weight: 0.30                 # Bumped up (was 0.25)
    adapter: "InfinigenAdapter"
    config:
      code_dir: "./data/infinigen/extracted_scripts"
      mesh_dir: "./data/infinigen/meshes"
      categories: null
      max_source_samples: null
    difficulty_distribution:
      easy:      0.40
      medium:    0.35
      hard:      0.20
      excellent: 0.05
    difficulty_thresholds:
      easy:      [0.10, 0.25]
      medium:    [0.25, 0.45]
      hard:      [0.45, 0.65]
      excellent: [0.65, 1.00]

  # --- Objaverse: multi-model LLM generation + best-of-N ---
  objaverse_llm:
    enabled: true
    weight: 0.40                 # Primary source (was 0.25)
    adapter: "ObjaverseLLMAdapter"
    config:
      data_dir: "./data/objaverse"
      lvis_categories:
        - "chair"
        - "table"
        - "lamp"
        - "sofa"
        - "bookshelf"
        - "cabinet"
        - "bed"
        - "desk"
        - "shelf"
        - "vase"
      models_for_generation:
        - "grok-4.1"
        - "claude-sonnet-4-20250514"
        - "qwen-3.5-plus"
      openrouter_api_key_env: "OPENROUTER_API_KEY"
      max_objects: 1000          # More objects to compensate for no MeshCoder
      max_retries: 2
      generation_timeout: 300
    difficulty_distribution:
      easy:      0.25
      medium:    0.35
      hard:      0.30
      excellent: 0.10
    difficulty_thresholds:
      easy:      [0.10, 0.25]
      medium:    [0.25, 0.45]
      hard:      [0.45, 0.65]
      excellent: [0.65, 1.00]

  # --- Synthetic self-play data (LLM writes code → execute → verify) ---
  synthetic_selfplay:
    enabled: true
    weight: 0.20                 # New source to fill MeshCoder gap
    adapter: "GenericJSONAdapter"
    config:
      name: "synthetic_selfplay"
      data_file: "./data/synthetic/selfplay_results.json"
      field_mapping:
        object_id: "id"
        category: "category"
        code: "blender_script"
        gt_mesh_path: "mesh_path"
        reward: "reward"
        success: "execution_success"
        chamfer: "chamfer_distance"
        f_score: "f_score_005"
    difficulty_distribution:
      easy:      0.50            # Self-play produces more easy samples
      medium:    0.30
      hard:      0.15
      excellent: 0.05
    difficulty_thresholds:
      easy:      [0.10, 0.25]
      medium:    [0.25, 0.45]
      hard:      [0.45, 0.65]
      excellent: [0.65, 1.00]

  # --- ShapeNet/PartNet: use if you have access ---
  shapenet:
    enabled: false
    weight: 0.10
    adapter: "ShapeNetAdapter"
    config:
      data_dir: "./data/shapenet"
      categories: ["chair", "table", "airplane", "car"]
      use_partnet_annotations: true
    difficulty_distribution:
      easy:      0.35
      medium:    0.35
      hard:      0.20
      excellent: 0.10
    difficulty_thresholds:
      easy:      [0.10, 0.25]
      medium:    [0.25, 0.45]
      hard:      [0.45, 0.65]
      excellent: [0.65, 1.00]

sampling:
  method: "stratified"
  stratified:
    axes:
      - name: "category"
        source: "metadata.category"
      - name: "difficulty"
        source: "computed.difficulty_bucket"
      - name: "code_complexity"
        source: "computed.code_complexity_bucket"
        num_bins: 3
    min_per_stratum: 1
    overflow_strategy: "drop_lowest_reward"
  facility_location:
    feature_columns:
      - "num_primitives"
      - "uses_boolean"
      - "uses_array"
      - "uses_curves"
      - "uses_extrude"
      - "num_parts"
      - "code_length"
      - "num_functions"
      - "uses_math"
      - "reward"
      - "chamfer_distance"
      - "f_score_005"
    selection_within_cluster: "max_reward"
  reward_top_k:
    ensure_min_per_category: 20

output:
  format: "jsonl"
  chat_template: "chatml"
  include_system_prompt: true
  system_prompt: |
    You are a 3D modeling assistant. Given one or more images of a 3D object,
    generate a Blender Python script that recreates the object's geometry.
    The script must: clear the scene, build geometry using bpy operations,
    normalize to a unit bounding box, and export as OBJ.
  include_metadata: true
  metadata_fields:
    - "source_dataset"
    - "category"
    - "object_id"
    - "num_views"
    - "reward"
    - "f_score_005"
    - "chamfer_distance"
    - "code_complexity_bucket"
    - "difficulty_bucket"
  generate_dpo_pairs: true
  dpo_output_dir: "./output/dpo_pairs_alt"
  dpo_min_reward_gap: 0.15

logging:
  level: "INFO"
  log_file: "./output/pipeline_alt.log"
  report_file: "./output/dataset_report_alt.json"
  generate_plots: true
  plot_dir: "./output/plots_alt"
